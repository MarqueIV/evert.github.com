---
title: "JWT appears to have become the default for tokens, and I'm a little surprised"
date: "2021-05-05 16:30:00 UTC"
tags: jwt, security
draft: true
---

Cookies
-------

When designing web applications, (especially the traditional HTML kind),
you will at one point have to figure out how log a user in, and keep them
logged in between requests.

The core mechanism we use for this are cookies. But, a user can control what's
in a cookie, so a cookie that contains a user id doesn't work:

```
Cookie: USER_ID=123
```

I can simply change the number, and now I'm identified as a different user.


Sessions
--------

The traditional way to solve this is what is often referred to as 'sessions'.
I don't know what the earliest usage of sessions is, but it's in every web
framework, and has been since web frameworks are a thing.

Often, 'sessions' and 'cookies' are described as 2 different things, but
they're really not. A session needs a cookie to work.

```
Cookie: MY_SESSION_ID=WW91IGdvdCBtZS4gRE0gbWUgb24gdHdpdHRlciBmb3IgYSBmcmVlIGNvb2tpZQ
```

Instead of a bare id, we're sending the client a completely random id that is
impossibly hard to guess.

On the server-side, it almost works a bit like a temporary password. We store
that id in a database, along with which user it blongs to. The cookie gets sent
along with every request, and it's secure because the string is meaningless and
unguessable. This is sometimes called an opaque token.

When a user logs out, you just delete the entry.

Languages like PHP have this built in, but by default will store session
data in the local filesystem. This made a lot of sense when sites were hosted
on long-lived bare-metal servers, but these days a deploy typically means
a completely fresh 'system', so this information needs to be stored in a place
that outlives the server. An easy choice is a database, but it's common for
sites to use systems like Redis and Memcached, which works for tiny sites, but
still works at massive scales.

This basic concept also extends to authenticating APIs using 'Bearer' or
'Access' tokens.


Encrypted token
---------------

Over 10 years ago, I started working a bit more with OAuth (1) and similar
authentication systems, and I wondered if we could just store all the
information in the cookie and cryptographically sign it:

<figure>
  <a href="https://stackoverflow.com/questions/3240246/signed-session-cookies-a-good-idea">
    <img src="/assets/posts/jwt/stackoverflow.png" alt="Question about session tokens on Stack Overflow" style="max-width: 100%"/>
  </a>
</figure>

Despite getting some good answers, I never went through with it as I didn't
feel confident enough in making this secure, and being a trailblazer in crypto
requires a better understanding in crypto than I did.

A few years later, we got JWT, and it's hot shit! JWT itself is a standard for
encrypting/signing JSON objects, but it's used a LOT for authentication.
Instead of an opaque tokens in a cookie, we actually embed the `user_id`  again,
but we include a signature. The signature can only be generated by the server,
and it's calculated using a 'secret' and the actual data in the cookie.

This means that if the data is tampered with (the `user_id` was changed), the
signature no longer matches.

So why is this useful? The best answer I have for this, is that it's not
needed to have a system for session data, like Redis or a database. All the
information is contained in the JWT, it means your infrastructure is in
theory simpler.

Drawbacks
---------

There's major drawbacks to using JWT.

First, it's a complicated standard and users are prone to get the settings
wrong. If the settings are wrong, in the worst case it could mean that *anyone*
can generate valid JWTs and impersonate anyone else. This is not a
beginners-level problem either, last year [Auth0][2] had a bug in one of
their products that had this very problem.

Auth0 is(/was?) a major vendor for security products, and ironically sponsor
the [jwt.io][3] website. If they're not safe, what chance does the long-tail
of devs have?

To be fair, the specific issue (allowing `none` as a "algorithm" by default)
is better now, and most libraries don't do this anymore. However, this issue
is part of a larger reason why many security experts [dislike][4] JWT: it has
a ton of features and options, which means there's a large surface area for
mistakes, by either library authors or users.

A second issue is 'logging out'. With traditional sessions, you can just
remove the session token from your session storage, which is effectively
enough to 'invalidate' the session

With JWT this is not possible. We can't remove the token, because it's
self-contained and there's no central authority that can invalidate them.

This is typically solved in two ways:

1. The tokens are made very short lived. For example, 5 minutes. Before the
   5 minutes are over, we generate a new one. (often using a separate refresh
   token).
2. Maintain a system that has a list of recently expired tokens.

Good systems will typically use both. An important thing to point out is,
in order to support logout, you'll likely still need a centralized storage
mechanism, which is the very thing that JWT were supposed to 'solve'.

A last issue with JWT is that they are relatively big, and when used in
cookies it adds a lot of per-request overhead.

All in all, that's a lot of drawbacks just to avoid a central session
store. It's not my opinion that JWT are universally a bad idea or without
benefits, but there are are things to consider.

Overall I feel that traditional session storage should probably be
everyone's default, and JWT should only be (carefully) considered if there
are real problems with the default.

The reverse seems to be true though!

Why are they popular?
---------------------

One thing that's surprised me when reading the tech blogs, is that there
is a _lot_ of chatter around JWT. Especially on Medium and subreddits like
[/r/node][5] I see intros to JWT on an extremely regular basis.

I realize that that doens't mean imply that 'JWTs are more popular than
session tokens', for the same reason that GraphQL isn't more popular than
REST, or NoSQL than relational databases: it's just not that interesting
to write about the technology that's been tried and tested for a decade or
more.

However, this phenomenon does create confusion for newcomers. If you keep
hearing about JWTs, it ends up becoming your default, even if it's the
sub-optimal choice. If enough new developers pick JWT as their default,
it could end up being the popular choice.

This is similar to many newer developers learning how to build SPAs with
React before server-rendered HTML.  experienced devs would likely feel that
server-rendered HTML should probably be your default choice, and building
an SPA *when needed*. This is however not the world we live in anymore.

I see this happening everywhere, but it surprised me for JWT. There's real
pitfalls, and it's (dare I say) objectively harder to to implement.

So as a small experiment, I looked up the top most popular (by votes) posts
on /r/node that mention JWT. I was going to go over the first 100, but got
bored after the top 12.

From these 12 articles and Github repos:

* 1 mentions using a revocation list, and 3 mention refesh tokens. The
  remaining articles and github repositories simply have no means of
  logging out.
* 1 article mentions that it _might_ be better to use a standard session
  storage instead.
* 1 github repository ships with pre-generated private keys. (yup)
* The ones that mention refresh tokens also suggest expiring after 5 minutes,
  some default to 7 days and 3 _never_ expire their JWTs.

Going through tons of Reddit posts and comments also got me a more refined
idea of why people think JWTs are better. The top reason everywhere is:
"it's more scalable". Which is similar to "You don't need a database", but
there's some nuance.

If you have an active session for every human on earth, and on average
each session takes about 1000 bytes, that's about 8 TB of storage, which
is chunky, but doable with conventional databases, and easier with a
distributed key-value store.

The vast majority of applications will of course never even get to 1% of
this. If you have not considered logging out for your application, chances
are that scaling a KV store is not going to be a major concern for you, like

[1]: https://crypto.stackexchange.com/questions/9336/is-hmac-md5-considered-secure-for-authenticating-encrypted-data
[2]: https://insomniasec.com/blog/auth0-jwt-validation-bypass
[3]: https://jwt.io/
[4]: https://paragonie.com/blog/2017/03/jwt-json-web-tokens-is-bad-standard-that-everyone-should-avoid
[5]: https://www.reddit.com/r/node/
